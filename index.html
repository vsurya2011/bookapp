<script>
// --- Global State & Configuration ---
const API_BASE = window.location.origin.includes('localhost') ? 'http://localhost:3000/api' : '/api';
const ALLOWED_DOMAIN = '@gmail.com';

// Simple state store using localStorage
const store = {
    // Get user object, which now includes the token
    get user() { return JSON.parse(localStorage.getItem('hub_user') || 'null') },
    set user(v) { localStorage.setItem('hub_user', JSON.stringify(v)) },
    
    get listings() { return JSON.parse(localStorage.getItem('hub_listings') || '[]') },
    set listings(v) { localStorage.setItem('hub_listings', JSON.stringify(v)) },
    currentView: 'home',
    activeListing: null
}

const qs = s => document.querySelector(s);
const qsa = s => document.querySelectorAll(s);

// --- Utility Functions ---
function openModal(m){ m.style.display='flex' }
function closeModal(m){ m.style.display='none' }
function escapeHtml(s){ return (s+"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[m])) }

function showMessage(msg, type = 'info') {
    // Basic console logging, replace with a UI alert if implemented
    console.log(`[${type.toUpperCase()}] ${msg}`);
}

// --- View Control ---
const viewContainer = qs('#viewContainer');
const navLinks = qsa('#navLinks .nav-link');

function setView(viewName) {
    if (['my-listings', 'add-listing'].includes(viewName) && !store.user) {
        showMessage('Please sign in to access this page.', 'info');
        openModal(qs('#authModal'));
        return;
    }

    store.currentView = viewName;
    
    qsa('section').forEach(s => s.classList.add('hidden'));
    qs(`#${viewName}View`).classList.remove('hidden');

    navLinks.forEach(link => {
        link.classList.toggle('active', link.dataset.view === viewName);
    });
    
    if (viewName === 'listings') {
        renderListingsGrid();
    } else if (viewName === 'my-listings') {
        renderMyListings();
    }
}


// --- API Fetch Utility (UPDATED to send Authorization Header) ---
async function apiFetch(path, options = {}) {
    const defaultHeaders = { 'Content-Type': 'application/json' };
    
    // Attach JWT token to all requests except login/signup/public GET /books
    if (store.user && store.user.token && !path.includes('/auth/')) {
        defaultHeaders['Authorization'] = `Bearer ${store.user.token}`;
    }

    const response = await fetch(API_BASE + path, {
        ...options,
        headers: {
            ...defaultHeaders,
            ...options.headers,
        },
    });

    if (response.ok) {
        // Successful DELETE returns 200, but no content
        if (options.method === 'DELETE' && response.status === 200) {
            return { success: true };
        }
        
        // GET /books returns an array directly, not wrapped in { data: [...] }
        if (path === '/books' && options.method === 'GET') {
            return await response.json();
        }
        
        const data = await response.json();
        
        if (data.success) {
            return data.data; // Return the actual data payload
        } else {
            showMessage(data.message || 'An unknown API error occurred.', 'error');
            return null;
        }
    } else {
        try {
            const errorBody = await response.json();
            showMessage(errorBody.message || `API Error: ${response.status} ${response.statusText}`, 'error');
        } catch (e) {
            showMessage(`Network or Server error: ${response.status} ${response.statusText}`, 'error');
        }
        // If 401/403, force logout
        if (response.status === 401 || response.status === 403) {
             handleLogout();
        }
        return null;
    }
}


// --- Theme Toggle (Remains the same) ---
const themeToggleBtn = qs('#themeToggle');
function toggleTheme() {
    const isLight = document.body.classList.toggle('light-theme');
    localStorage.setItem('hub_theme', isLight ? 'light' : 'dark');
    themeToggleBtn.innerHTML = isLight ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"></path></svg>' : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>';
}
themeToggleBtn.addEventListener('click', toggleTheme);
const savedTheme = localStorage.getItem('hub_theme');
if (savedTheme === 'light') {
    document.body.classList.add('light-theme');
    // Ensure icon is correctly set
    themeToggleBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"></path></svg>';
}

// --- Authentication (UPDATED for JWT) ---
const authBtn = qs('#authBtn');
const authModal = qs('#authModal');
const authForm = qs('#authForm');

function updateAuthUI() {
    if (store.user) {
        // User is logged in, display name and Sign Out
        authBtn.textContent = store.user.name.split(' ')[0] + ' • Sign Out';
        authBtn.classList.remove('brand');
        authBtn.classList.add('ghost');
    } else {
        // User is logged out, display Sign In
        authBtn.textContent = 'Sign In';
        authBtn.classList.remove('ghost');
        authBtn.classList.add('brand');
        setView('home'); // Redirect if the current view requires login
    }
    updateHomeStats(); 
}

function handleLogout() {
    store.user = null; // Clear local storage
    updateAuthUI(); 
    showMessage('Logged out successfully.', 'info');
}

// Attach Sign In/Out button listener
authBtn.addEventListener('click', (e) => {
    if (store.user) {
        handleLogout();
    } else {
        openModal(authModal);
    }
});

authForm.addEventListener('submit', handleAuthSubmit);

async function handleAuthSubmit(e) {
    e.preventDefault();
    const form = e.target;
    // Check if the form has a name input, which indicates the Sign Up form
    const isLogin = form.querySelector('[name="password"]') && form.querySelector('[name="name"]').value === 'NOT_USED'; 

    const email = form.querySelector('[name="email"]').value.trim();
    const password = form.querySelector('[name="password"]').value.trim();
    const nameInput = form.querySelector('[name="name"]');
    const name = nameInput ? nameInput.value.trim() : '';

    if (!email || !password || (isLogin === false && !name)) {
        showMessage('Please fill in all required fields.', 'error');
        return;
    }

    const payload = { email, password };
    let path = '/auth/login';

    if (nameInput.value !== 'NOT_USED') {
        // This is a Sign Up attempt
        path = '/auth/signup';
        payload.name = name; 
    }

    const submitBtn = form.querySelector('[type="submit"]');
    submitBtn.disabled = true;

    const userData = await apiFetch(path, {
        method: 'POST',
        body: JSON.stringify(payload),
    });

    submitBtn.disabled = false; 

    if (userData) {
        store.user = userData; // Store user data including JWT token
        closeModal(authModal);
        updateAuthUI();
        showMessage(path.includes('login') ? 'Welcome back! Login successful.' : 'Account created! Welcome to Book Hub.', 'success');
        setView('listings'); 
    }
}


// --- Listings/Data Fetch and Rendering (Mostly the same, updated to use new data structure) ---

function applyFilters(data, forMyListings) {
    const q = qs('#q') || { value: '' };
    const typeFilter = qs('#typeFilter') || { value: '' };
    const condFilter = qs('#condFilter') || { value: '' };
    const sortBy = qs('#sortBy') || { value: 'new' };

    let res = data;

    if (forMyListings && store.user) {
        res = res.filter(d => d.owner.userId === store.user.userId); 
    }

    const term = q.value.trim().toLowerCase();
    res = res.filter(d => {
        const str = (d.title + ' ' + d.author + ' ' + (d.subject || '') + ' ' + d.description).toLowerCase();
        if (term && !str.includes(term)) return false;
        if (typeFilter.value && d.type !== typeFilter.value) return false;
        if (condFilter.value && d.condition !== condFilter.value) return false;
        return true;
    });

    switch (sortBy.value) {
        case 'priceAsc': res.sort((a, b) => a.price - b.price); break;
        case 'priceDesc': res.sort((a, b) => b.price - a.price); break;
        case 'title': res.sort((a, b) => a.title.localeCompare(b.title)); break;
        default: res.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    }
    return res;
}

function createListingCard(d, isOwnerView) {
    const ownerName = d.owner && d.owner.name ? d.owner.name.split(' ')[0] : 'Unknown';
    const priceDisplay = d.type === 'Exchange' ? `<span class="tag" style="background:var(--brand-2); color:white">EXCHANGE</span>`
        : d.type === 'Buy' ? `<span class="tag" style="background:var(--brand); color:white">WANT TO BUY</span>`
        : `<span class="price">₹ ${Number(d.price).toLocaleString()}</span>`;

    const card = document.createElement('div');
    card.className = 'listing-card';
    card.innerHTML = `
        <img src="${d.image || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect width="100%" height="100%" fill="var(--border)"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="var(--muted)" font-family="Inter" font-size="16">No Cover</text></svg>'}" alt="${escapeHtml(d.title)} Cover">
        <div class="info">
            <div class="row" style="justify-content:space-between">
                <div class="tag">${escapeHtml(d.condition)}</div>
                ${priceDisplay}
            </div>
            <h3>${escapeHtml(d.title)}</h3>
            <div class="fine">by ${escapeHtml(d.author || 'Unknown')}</div>
            <div class="meta">
                <span>Type: ${escapeHtml(d.type)}</span> | 
                <span>Posted by: ${ownerName}</span>
            </div>
            <div class="row" style="margin-top:auto; padding-top:10px; border-top:1px dashed var(--border)">
                <button class="btn ghost grow" data-action="view-details">Details & Messages</button>
                ${isOwnerView ? `<button class="btn brand" style="background:#dc2626" data-action="remove">Remove</button>` : ''}
            </div>
        </div>
    `; 
    card.addEventListener('click', (e) => {
        const action = e.target.dataset.action;
        if (action === 'remove') {
            handleDeleteListing(d._id, d.title);
        } else {
            showDetailModal(d);
        }
    });
    return card;
}

function renderListingsGrid() {
    const allData = store.listings;
    const filteredData = applyFilters(allData, false);
    const grid = qs('#listingsGrid');
    grid.innerHTML = '';
    qs('#statTotalBooks').textContent = allData.length;

    if (!filteredData.length) {
        qs('#emptyListings').classList.remove('hidden');
        return;
    }
    qs('#emptyListings').classList.add('hidden');
    filteredData.forEach(d => grid.appendChild(createListingCard(d, false)));
}

function renderMyListings() {
    if (!store.user) {
        qs('#myListingsGrid').innerHTML = '';
        qs('#emptyMyListings').classList.remove('hidden');
        qs('#myListingsCount').textContent = '0';
        qs('#statMyListings').textContent = '0';
        return;
    }
    
    const myListings = applyFilters(store.listings, true);
    const grid = qs('#myListingsGrid');
    grid.innerHTML = '';
    qs('#myListingsCount').textContent = myListings.length;
    qs('#statMyListings').textContent = myListings.length;

    if (!myListings.length) {
        qs('#emptyMyListings').classList.remove('hidden');
        return;
    }
    qs('#emptyMyListings').classList.add('hidden');
    myListings.forEach(d => grid.appendChild(createListingCard(d, true)));
}

function updateHomeStats() {
    qs('#statTotalBooks').textContent = store.listings.length;
    if (store.user) {
        const myListings = store.listings.filter(d => d.owner.userId === store.user.userId);
        qs('#statMyListings').textContent = myListings.length;
    } else {
        qs('#statMyListings').textContent = '0';
    }
}

async function loadAndRenderListings() {
    // GET /api/books is public, so no token is needed here
    const data = await apiFetch('/books', { method: 'GET' }); 
    if (data) {
        store.listings = data; // Cache in store
        renderListingsGrid();
        renderMyListings(); 
        updateHomeStats();
    }
}

// Event Listeners for Filters
qsa('#q, #typeFilter, #condFilter, #sortBy').forEach(el => el.addEventListener('input', renderListingsGrid));
qs('#clearFilters').addEventListener('click', () => {
    qs('#q').value = '';
    qs('#typeFilter').value = '';
    qs('#condFilter').value = '';
    qs('#sortBy').value = 'new';
    renderListingsGrid();
});

// --- Detail Modal Functions ---
const detailModal = qs('#detailModal');
const detailContent = qs('#detailContent');

function renderMessages(msgs) {
    if (!msgs || msgs.length === 0) return '<p class="fine" style="text-align:center">No messages yet.</p>';
    // Sort messages by timestamp if they are not already
    msgs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

    return msgs.map(m => `
        <div class="msg-item">
            <div class="sender">${escapeHtml(m.by)} <span class="fine" style="float:right">${new Date(m.timestamp).toLocaleString()}</span></div>
            <div>${escapeHtml(m.text)}</div>
        </div>
    `).join('');
}

function showDetailModal(listing) {
    store.activeListing = listing;
    qs('#detailTitle').textContent = listing.title;
    
    const isOwner = store.user && store.user.userId === listing.owner.userId;
    const ownerName = escapeHtml(listing.owner.name);
    
    const priceDisplay = listing.type === 'Exchange' ? `<span class="price" style="color:var(--brand-2)">EXCHANGE</span>` 
        : listing.type === 'Buy' ? `<span class="price" style="color:var(--brand-2)">WANT TO BUY</span>`
        : `<span class="price" style="color:var(--brand)">₹ ${Number(listing.price).toLocaleString()}</span>`;

    detailContent.innerHTML = `
        <div id="detailView">
            <div id="detailMedia">
                <img id="detailImage" src="${listing.image || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect width="100%" height="100%" fill="var(--border)"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="var(--muted)" font-family="Inter" font-size="16">No Cover</text></svg>'}" alt="${escapeHtml(listing.title)} Cover">
            </div>
            <div id="detailInfo">
                <h1>${escapeHtml(listing.title)}</h1>
                <div class="fine" style="margin-bottom:15px">${escapeHtml(listing.author || 'Unknown')} • ${escapeHtml(listing.condition)}</div>
                ${priceDisplay}
                <div style="margin-top:10px; color:var(--muted)">Posted by: <strong>${ownerName}</strong> (${escapeHtml(listing.owner.email)})</div>
                
                <p style="margin-top:20px">${escapeHtml(listing.description)}</p>

                ${isOwner ? `<button class="btn brand" style="background:#dc2626; margin-top:20px" data-action="remove-detail">Remove Listing</button>` : ''}
                
                <div id="messageThread">
                    <h3>Messages (${listing.msgs ? listing.msgs.length : 0}) ${isOwner ? '<span class="fine">(Only visible to you)</span>' : ''}</h3>
                    <div id="messageList" style="max-height: 250px; overflow-y: auto; margin-bottom: 20px;">
                        ${isOwner && listing.msgs ? renderMessages(listing.msgs) : '<p class="fine" style="text-align:center">Messages are only visible to the listing owner.</p>'}
                    </div>
                    
                    ${store.user && !isOwner ? `
                    <form id="messageForm">
                        <label>Send a message to the seller</label>
                        <textarea id="msgText" placeholder="I'm interested in this book, is it still available?" required></textarea>
                        <div style="text-align:right; margin-top:10px">
                            <button type="submit" class="btn brand">Send Message</button>
                        </div>
                    </form>` : store.user && isOwner ? '' : `
                    <p class="fine" style="text-align:center">Please sign in to send a message to the seller.</p>
                    <button class="btn brand" style="width:100%" onclick="openModal(authModal); closeModal(detailModal)">Sign In to Message</button>
                    `}
                </div>
            </div>
        </div>
    `;

    // Re-attach listeners for dynamically created form/buttons
    const messageForm = qs('#messageForm');
    if (messageForm) {
        messageForm.addEventListener('submit', handleAddMessage);
    }
    
    // Listener for remove button inside detail view
    qs('#detailContent').addEventListener('click', (e) => {
        if (e.target.dataset.action === 'remove-detail' && store.activeListing) {
            handleDeleteListing(store.activeListing._id, store.activeListing.title);
            closeModal(detailModal); // Close modal after action initiated
        }
    });

    openModal(detailModal);
}

// --- CRUD Handlers ---

// 1. Add Listing
const listingForm = qs('#listingForm');
const imageInput = qs('#imageInput');
const preview = qs('#preview'); 
let previewBase64 = ''; 

imageInput.addEventListener('change', (e)=>{
    const f = e.target.files?.[0];
    if(!f){
        preview.style.display='none';
        previewBase64='';
        return
    }
    const reader = new FileReader();
    reader.onload = ()=>{
        preview.src = reader.result;
        preview.style.display='inline-block';
        previewBase64 = reader.result; // Store Base64 string
    }
    reader.readAsDataURL(f);
});

listingForm.addEventListener('submit', handleListingSubmit);

async function handleListingSubmit(e) {
    e.preventDefault();
    if (!store.user) {
        showMessage('You must be signed in to add a listing.', 'error');
        openModal(authModal);
        return;
    }
    
    // Gather form data
    const formData = new FormData(listingForm);
    const payload = {
        title: formData.get('title'),
        author: formData.get('author'),
        description: formData.get('description'),
        price: formData.get('price'),
        type: formData.get('type'),
        condition: formData.get('condition'),
        image: previewBase64, 
    };

    const submitBtn = listingForm.querySelector('[type="submit"]');
    submitBtn.disabled = true;

    // POST /api/books - requires the Authorization header via apiFetch
    const newBook = await apiFetch('/books', {
        method: 'POST',
        body: JSON.stringify(payload)
    });
    
    submitBtn.disabled = false;

    if (newBook) {
        showMessage(`Listing for "${newBook.title}" successfully published!`, 'success');
        listingForm.reset();
        qs('#preview').style.display = 'none';
        previewBase64 = ''; 
        
        // Add the new book to the local cache and refresh all views
        store.listings = [newBook, ...store.listings]; 
        
        renderListingsGrid();
        renderMyListings();
        updateHomeStats();
        setView('listings');
    }
}

// --- Delete Listing ---
async function handleDeleteListing(id, title) {
    if (!confirm(`Are you sure you want to delete the listing for "${title}"? This action cannot be undone.`)) {
        return;
    }
    
    const response = await apiFetch(`/books/${id}`, {
        method: 'DELETE'
    });
    
    if (response) {
        showMessage('Listing deleted successfully.', 'success');
        
        // Optimistically update cache and re-render
        store.listings = store.listings.filter(d => d._id !== id);
        renderMyListings(); 
        renderListingsGrid(); 
        updateHomeStats(); 
    }
}

// 3. Add Message
async function handleAddMessage(e) {
  e.preventDefault();
  if (!store.user || !store.activeListing) {
      showMessage('Please sign in to send a message.', 'error');
      openModal(authModal);
      return;
  }

  const msgTextEl = qs('#msgText');
  const text = msgTextEl.value.trim();
  if (!text) return;

  const messagePayload = {
    text: text
  };
  
  const submitBtn = e.target.querySelector('[type="submit"]');
  submitBtn.disabled = true;

  // POST /api/books/:id/message - requires Authorization header
  const response = await apiFetch(`/books/${store.activeListing._id}/message`, {
    method: 'POST',
    body: JSON.stringify(messagePayload)
  });
  
  submitBtn.disabled = false;

  if (response) {
    // Response is the new message object
    
    // Update the message array in the local cache
    const localListing = store.listings.find(d => d._id === store.activeListing._id);
    if (localListing) {
        localListing.msgs.push(response);
        store.activeListing.msgs.push(response); 
    }
    
    // Re-render the messages in the modal
    qs('#messageList').innerHTML = renderMessages(store.activeListing.msgs);
    msgTextEl.value = '';
    showMessage('Message sent successfully. Only the owner can view it.', 'success');
  }
}


// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    // Check if user is already logged in from a previous session
    updateAuthUI();
    
    // Load data from the MongoDB backend and render the default view
    loadAndRenderListings();
    setView(store.currentView);
});
</script>
