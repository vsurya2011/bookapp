<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Used Books Hub â€” College Buy/Sell/Exchange</title>
  <style>
    /* ----------------- New & Improved Styling ----------------- */
    :root{
      --bg:#020617; /* slate-950 (Darker background) */
      --card:#0f172a; /* slate-900 */
      --muted:#94a3b8; /* slate-400 */
      --text:#f8fafc; /* gray-50 */
      --brand:#34d399; /* emerald-400 (New Brand Green) */
      --brand-2:#6366f1; /* indigo-500 */
      --danger:#f87171; /* red-400 */
      --warn:#fbbf24; /* amber-400 */
      --ok:#4ade80; /* green-400 */
      --chip:#1e293b; /* slate-800 */
      --shadow: 0 15px 35px rgba(0,0,0,.5);
      --radius: 12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
    header{position:sticky;top:0;background:rgba(2,6,23,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--chip);z-index:5}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.5px;font-size:1.2rem}
    .brand span{background:linear-gradient(135deg,var(--brand),var(--brand-2));-webkit-background-clip:text;background-clip:text;color:transparent}
    .btn{appearance:none;border:0;border-radius:999px;padding:10px 18px;font-weight:600;color:var(--card);background:var(--text);cursor:pointer;transition:transform .1s ease,box-shadow .2s ease;box-shadow:0 3px 10px rgba(0,0,0,.2);display:inline-flex;align-items:center;justify-content:center;gap:8px;text-decoration:none}
    .btn:hover{transform:translateY(-1px);box-shadow:0 5px 15px rgba(0,0,0,.3)}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid var(--chip);box-shadow:none}
    .btn.ghost:hover{background:var(--chip)}
    .btn.brand{background:linear-gradient(135deg,var(--brand-2),var(--brand));color:var(--card)}
    .btn.danger{background:var(--danger);color:var(--text)}
    .tag{background:var(--chip);border:1px solid #334155;color:var(--muted);padding:6px 10px;border-radius:999px;font-size:.85rem;font-weight:500}
    .pill{padding:3px 9px;border-radius:999px;background:#1e293b;border:1px solid #334155;color:var(--brand);font-size:.75rem}

    main{max-width:1200px;margin:32px auto;padding:0 16px;display:grid;grid-template-columns:300px 1fr;gap:24px}
    @media (max-width: 1000px){main{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--chip);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .hd{padding:18px 20px;border-bottom:1px solid var(--chip);font-weight:700;font-size:1.1rem;color:var(--brand-2)}
    .card .bd{padding:20px}

    /* Filters */
    .filters input,.filters select{width:100%;padding:12px 14px;margin-bottom:12px;border-radius:10px;border:1px solid var(--chip);background:var(--bg);color:var(--text)}

    /* Grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:24px}
    .listing{display:flex;flex-direction:column;border-radius:14px;overflow:hidden;background:var(--bg);border:1px solid var(--chip);transition:box-shadow .2s ease, transform .1s ease;box-shadow:0 0 10px rgba(0,0,0,.15)}
    .listing:hover{box-shadow:0 5px 20px rgba(0,0,0,.4);transform:translateY(-2px)}
    .listing img{width:100%;height:180px;object-fit:cover;background:var(--chip);border-bottom:1px solid var(--chip)}
    .listing .info{padding:16px;display:flex;flex-direction:column;gap:10px;flex-grow:1}
    .price{font-weight:900;font-size:1.5rem;color:var(--brand)}
    .meta{display:flex;gap:10px;flex-wrap:wrap}
    .listing h3{margin:0;font-size:1.2rem;line-height:1.4}
    .listing .fine{font-size:.85rem}
    .listing .actions{margin-top:auto;padding-top:10px;border-top:1px solid var(--chip);display:flex;gap:10px}
    .listing .actions .btn{padding:8px 12px;font-size:.9rem}

    /* Forms */
    label{font-size:.9rem;color:var(--muted);font-weight:500}
    input[type="text"],input[type="number"],input[type="email"],textarea,select{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--chip);background:var(--bg);color:var(--text);margin-top:6px;font-size:1rem}
    textarea{min-height:90px}
    .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    @media (max-width: 720px){.form-grid{grid-template-columns:1fr}}

    /* Modals (Responsive & Clean) */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;padding:20px;z-index:50;overflow-y:auto}
    .modal .panel{width:min(400px,96vw);background:var(--card);border:1px solid var(--chip);border-radius:18px;box-shadow:var(--shadow)}
    #contactModal .panel{width:min(640px,96vw)}
    #aboutModal .panel{width:min(550px,96vw)}

    .modal .panel .hd{display:flex;justify-content:space-between;align-items:center;padding:18px 20px;border-bottom:1px solid var(--chip);font-weight:700}
    .modal .panel .bd{padding:20px}
    .modal-subtitle{font-size:.9rem;color:var(--muted);margin-bottom:20px}

    /* Login Modal Specific Styles */
    #loginForm label{margin-top:10px;display:block}
    .google-btn{background:white;color:#111827;border:1px solid #e5e7eb;box-shadow:none;width:100%;margin-bottom:10px;font-weight:600;padding:12px 18px}
    .google-btn:hover{background:#f3f4f6;transform:none}
    .google-btn svg{width:18px;height:18px}
    .divider{display:flex;align-items:center;text-align:center;color:var(--muted);margin:20px 0}
    .divider::before,.divider::after{content:'';flex:1;border-bottom:1px solid var(--chip);margin:0 10px}

    .empty{padding:24px;text-align:center;color:var(--muted);font-size:1.1rem;margin-top:40px}
    footer{max-width:1200px;margin:30px auto 60px;color:#8b9bc7;opacity:.9;padding:0 16px}
    a{color:var(--brand)}
    .fine{font-size:.9rem;color:var(--muted)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    
    /* Message Thread */
    .msg-item{border:1px solid #1f2937;padding:10px 12px;border-radius:10px;margin:8px 0;background:#0e1328;line-height:1.4}
    .msg-item .sender{font-weight:700;color:var(--brand)}
  </style>
</head>
<body>
  <header>
    <div class="container row">
      <div class="brand">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M5 4h9a4 4 0 0 1 0 8H5V4Zm0 8h11a4 4 0 1 1 0 8H5v-8Z" stroke="var(--brand)" stroke-width="1.3"/></svg>
        <div>Used Books <span>Hub</span></div>
        <span class="pill" id="domainPill">domain: @college.edu</span>
      </div>
      <div class="grow"></div>
      <button class="btn ghost" id="aboutBtn">About</button>
      <button class="btn brand" id="loginBtn"><span id="loginLabel">Sign In</span></button>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="hd">Filter Listings</div>
      <div class="bd filters">
        <input id="q" type="text" placeholder="Search by title, author, course, subjectâ€¦" />
        <div class="row">
          <select id="typeFilter" class="grow">
            <option value="">All types</option>
            <option>Sell</option>
            <option>Buy</option>
            <option>Exchange</option>
          </select>
          <select id="condFilter" class="grow">
            <option value="">Any condition</option>
            <option>Like New</option>
            <option>Good</option>
            <option>Fair</option>
          </select>
        </div>
        <div class="row">
          <input id="minPrice" type="number" placeholder="Min price (â‚¹)" />
          <input id="maxPrice" type="number" placeholder="Max price (â‚¹)" />
        </div>
        <div class="row">
          <select id="sortBy" class="grow">
            <option value="new">Newest</option>
            <option value="priceAsc">Price: Low to High</option>
            <option value="priceDesc">Price: High to Low</option>
            <option value="title">Title Aâ†’Z</option>
          </select>
          <button class="btn ghost" id="clearFilters">Clear</button>
        </div>
      </div>
    </section>

    <section class="card" id="addCard">
      <div class="hd">List a Book</div>
      <div class="bd">
        <form id="listingForm">
          <div class="form-grid">
            <div>
              <label>Type
                <select name="type" required>
                  <option>Sell</option>
                  <option>Buy</option>
                  <option>Exchange</option>
                </select>
              </label>
            </div>
            <div>
              <label>Price (â‚¹) <span class="fine">(0 for Exchange/Want-to-Buy)</span>
                <input name="price" type="number" min="0" value="0" required />
              </label>
            </div>
            <div>
              <label>Title
                <input name="title" type="text" required placeholder="e.g., Data Structures in C" />
              </label>
            </div>
            <div>
              <label>Author
                <input name="author" type="text" placeholder="e.g., Seymour Lipschutz" />
              </label>
            </div>
            <div>
              <label>Course/Subject
                <input name="subject" type="text" placeholder="e.g., CSE201 / Algorithms" />
              </label>
            </div>
            <div>
              <label>Condition
                <select name="condition">
                  <option>Like New</option>
                  <option>Good</option>
                  <option>Fair</option>
                </select>
              </label>
            </div>
          </div>

          <label style="margin-top:16px;display:block">Description
            <textarea name="description" placeholder="Edition, highlights, notes, exchange preferences, etc."></textarea>
          </label>

          <div class="row" style="margin-top:16px;align-items:flex-end">
            <div style="flex-grow:0.5">
              <label>Cover Image
                <input name="image" id="imageInput" type="file" accept="image/*" />
              </label>
            </div>
            <img id="preview" alt="Preview" style="width:80px;height:80px;object-fit:cover;border-radius:10px;border:1px solid var(--chip);margin-left:8px;display:none" />
            <div class="grow"></div>
            <button class="btn brand" type="submit">Publish Listing</button>
          </div>
        </form>
      </div>
    </section>

    <section class="card" style="grid-column:1/-1">
      <div class="hd">Available Books</div>
      <div class="bd">
        <div id="listings" class="grid"></div>
        <div id="empty" class="empty" style="display:none">No listings match your filters yet.</div>
      </div>
    </section>
  </main>

  <footer>
    <div class="fine"><strong>Problem.</strong> College textbooks are expensive; used books go unused; lack of a central, trusted, college-exclusive platform.</div>
    <div style="margin-top:4px" class="fine"><strong>Solution.</strong> A hub for college students to securely buy, sell, and exchange books with powerful filtering.</div>
    <div style="margin-top:16px;text-align:center" class="fine">This is a single-file HTML/JS demo prototype. Real authentication requires a backend server.</div>
  </footer>

  <div class="modal" id="loginModal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="panel">
      <div class="hd">
        <span id="loginTitle">Account Access</span>
        <button class="btn ghost" id="closeLogin">Close</button>
      </div>
      <div class="bd">
        <button class="btn google-btn" disabled>
          <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" aria-hidden="true"><path fill="#fbc02d" d="M43.6 20.4H24v7.2h10.8c-.8 4.4-4.8 7.6-10.8 7.6-6.6 0-12-5.4-12-12s5.4-12 12-12c3.2 0 6.2 1.2 8.4 3.2l5.6-5.6c-4.2-4-9.8-6.4-16-6.4C12 4.8 4 12.8 4 24s8 19.2 20 19.2c12 0 19.2-8 19.2-19.2 0-1.6-.2-3.2-.4-4.8z"/><path fill="#e53935" d="M4 24c0-3.6.8-7 2.4-10.2l6.2 4.8c-.6 1.8-.8 3.8-.8 5.4s.2 3.6.8 5.4l-6.2 4.8c-1.6-3.2-2.4-6.6-2.4-10.2z"/><path fill="#4caf50" d="M24 43.6c-5.4 0-10.2-2.2-13.6-5.6l6.2-4.8c3.2 2 7 3.2 11 3.2 4.6 0 8.6-2 11.4-5.4l6.2 4.8c-3 4.2-7.8 6.8-13.6 6.8z"/><path fill="#1976d2" d="M43.6 20.4c0-1.6-.2-3.2-.4-4.8H24v9.6h10.8c.6 3.8 3.8 6.6 8.4 6.6 2.4 0 4.6-.6 6.4-1.8l-5.6-5.6c-1.4-1.2-3.4-1.8-5.2-1.8z"/></svg>
          Continue with Google <span class="fine">(Demo Not Active)</span>
        </button>

        <div class="divider">OR</div>

        <form id="loginForm">
          <div class="modal-subtitle">Use your College Email for verification</div>
          <div>
            <label>Full Name
              <input name="name" type="text" required placeholder="e.g., Priya Sharma" />
            </label>
          </div>
          <div>
            <label>College Email
              <input name="email" type="email" required placeholder="name@college.edu" />
            </label>
          </div>
          <div class="fine" style="margin:16px 0 10px">Your email must match the allowed domain (<span id="loginDomain">@college.edu</span>). No passwords are collected.</div>
          <div class="row" style="margin-top:10px">
            <div class="grow"></div>
            <button class="btn brand" type="submit">Verify & Sign In</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal" id="aboutModal" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
    <div class="panel">
      <div class="hd">
        <span id="aboutTitle">About This Demo</span>
        <button class="btn ghost" id="closeAbout">Close</button>
      </div>
      <div class="bd">
        <p>This is a <strong>singleâ€‘file HTML</strong> prototype that runs locally, but is deployed online. It demonstrates key features:</p>
        <ul>
          <li>Collegeâ€‘exclusive signâ€‘in (domainâ€‘based verification)</li>
          <li>Persistent login (details saved in browser's storage)</li>
          <li>Add/Filter/Sort listings (stored in <code>localStorage</code>)</li>
          <li>Direct contact via email draft + lightweight inâ€‘app messages</li>
          <li>Buy / Sell / Exchange types</li>
        </ul>
        <p class="fine">For a full production app, this UI would be connected to your deployed **Node.js server** with a database (like the MongoDB Atlas connection you just fixed!) and use secure, external authentication (like Google OAuth) instead of this demo login.</p>
      </div>
    </div>
  </div>

  <div class="modal" id="contactModal" role="dialog" aria-modal="true" aria-labelledby="contactTitle">
    <div class="panel">
      <div class="hd">
        <span id="contactTitle">Contact Seller</span>
        <button class="btn ghost" id="closeContact">Close</button>
      </div>
      <div class="bd">
        <div id="contactInfo" class="fine" style="margin-bottom:12px"></div>
        <form id="msgForm">
          <label class="sr-only">Message</label>
          <textarea id="msgText" placeholder="Type a message to the sellerâ€¦"></textarea>
          <div class="row" style="margin-top:12px">
            <a id="mailtoLink" class="btn ghost" href="#">Email Draft</a>
            <div class="grow"></div>
            <button class="btn brand" type="submit">Send Inâ€‘App</button>
          </div>
        </form>
        <div id="thread" style="margin-top:20px"></div>
      </div>
    </div>
  </div>

  <script>
    // ----------------- Simple State -----------------
    const ALLOWED_DOMAIN = '@college.edu'; // Change this to your domain (e.g., '@mycollege.edu.in')
    document.getElementById('domainPill').textContent = 'domain: ' + ALLOWED_DOMAIN;
    document.getElementById('loginDomain').textContent = ALLOWED_DOMAIN;

    const store = {
      get user(){ return JSON.parse(localStorage.getItem('ub_user')||'null') },
      set user(v){ localStorage.setItem('ub_user', JSON.stringify(v)) },
      get listings(){ return JSON.parse(localStorage.getItem('ub_listings')||'[]') },
      set listings(v){ localStorage.setItem('ub_listings', JSON.stringify(v)) },
      save(){ /* helper if needed */ }
    }

    const qs = s => document.querySelector(s);
    const elListings = qs('#listings');
    const elEmpty = qs('#empty');

    // ----------------- Auth -----------------
    const loginBtn = qs('#loginBtn');
    const loginLabel = qs('#loginLabel');
    const loginModal = qs('#loginModal');
    const closeLogin = qs('#closeLogin');
    const loginForm = qs('#loginForm');

    function openModal(m){ m.style.display='flex' }
    function closeModal(m){ m.style.display='none' }

    loginBtn.addEventListener('click',()=>{
      if(store.user){
        if(confirm('Sign out '+store.user.name.split(' ')[0]+'?')){
          localStorage.removeItem('ub_user');
          updateAuthUI();
        }
      }else{
        openModal(loginModal)
      }
    })
    closeLogin.addEventListener('click',()=>closeModal(loginModal))

    loginForm.addEventListener('submit',e=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(loginForm).entries());
      const emailOk = data.email.toLowerCase().endsWith(ALLOWED_DOMAIN.toLowerCase());
      if(!emailOk){
        alert('Verification Failed: Email must end with '+ALLOWED_DOMAIN+'.');
        return;
      }
      store.user = { name:data.name.trim(), email:data.email.trim(), verified:true, createdAt:Date.now() };
      updateAuthUI();
      closeModal(loginModal);
    })

    function updateAuthUI(){
      if(store.user){
        loginLabel.textContent = store.user.name.split(' ')[0]+' â€¢ Sign Out';
        qs('#addCard').style.display = 'block';
        // Pre-fill login form with remembered details
        qs('#loginForm input[name="name"]').value = store.user.name;
        qs('#loginForm input[name="email"]').value = store.user.email;
      } else {
        loginLabel.textContent = 'Sign In';
        // Note: Listing is allowed for demo even without login. Change 'block' to 'none' to enforce login.
        qs('#addCard').style.display = 'block';
        // Clear form on sign-out
        qs('#loginForm input[name="name"]').value = '';
        qs('#loginForm input[name="email"]').value = '';
      }
    }

    // ----------------- Add Listing -----------------
    const listingForm = qs('#listingForm');
    const imageInput = qs('#imageInput');
    const preview = qs('#preview');

    let previewBase64 = '';
    imageInput.addEventListener('change', (e)=>{
      const f = e.target.files?.[0];
      if(!f){ preview.style.display='none'; previewBase64=''; return }
      const reader = new FileReader();
      reader.onload = ()=>{ preview.src = reader.result; preview.style.display='inline-block'; previewBase64 = reader.result }
      reader.readAsDataURL(f);
    })

    listingForm.addEventListener('submit', e=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(listingForm).entries());
      const id = 'L'+Math.random().toString(36).slice(2,9);
      const owner = store.user || { name:'Guest', email:'guest@example.com'};
      const price = Number(data.price||0);
      const rec = {
        id,
        type:data.type,
        price:isNaN(price)?0:price,
        title:data.title.trim(),
        author:(data.author||'').trim(),
        subject:(data.subject||'').trim(),
        condition:data.condition,
        description:(data.description||'').trim(),
        image: previewBase64,
        owner,
        createdAt: Date.now(),
        msgs: []
      }
      const list = store.listings; list.unshift(rec); store.listings = list;
      listingForm.reset(); preview.style.display='none'; previewBase64='';
      alert(`Listing "${rec.title}" Published!`);
      render();
    })

    // ----------------- Filters -----------------
    const q = qs('#q');
    const typeFilter = qs('#typeFilter');
    const condFilter = qs('#condFilter');
    const minPrice = qs('#minPrice');
    const maxPrice = qs('#maxPrice');
    const sortBy = qs('#sortBy');
    const clearFilters = qs('#clearFilters');

    ;[q,typeFilter,condFilter,minPrice,maxPrice,sortBy].forEach(el=>el.addEventListener('input',render))
    clearFilters.addEventListener('click',()=>{
      q.value='';typeFilter.value='';condFilter.value='';minPrice.value='';maxPrice.value='';sortBy.value='new';render();
    })

    function applyFilters(data){
      const term = q.value.trim().toLowerCase();
      let res = data.filter(d=>{
        const str = (d.title+' '+d.author+' '+d.subject+' '+d.description).toLowerCase();
        if(term && !str.includes(term)) return false;
        if(typeFilter.value && d.type!==typeFilter.value) return false;
        if(condFilter.value && d.condition!==condFilter.value) return false;
        if(minPrice.value && d.price < Number(minPrice.value)) return false;
        if(maxPrice.value && d.price > Number(maxPrice.value)) return false;
        return true;
      });
      switch(sortBy.value){
        case 'priceAsc': res.sort((a,b)=>a.price-b.price); break;
        case 'priceDesc': res.sort((a,b)=>b.price-a.price); break;
        case 'title': res.sort((a,b)=>a.title.localeCompare(b.title)); break;
        default: res.sort((a,b)=>b.createdAt-a.createdAt);
      }
      return res;
    }

    // ----------------- Render (Updated for Attractive UI) -----------------
    function render(){
      updateAuthUI();
      const data = applyFilters(store.listings);
      elListings.innerHTML = '';
      if(!data.length){ elEmpty.style.display='block'; return } else { elEmpty.style.display='none' }
      
      const currentUser = store.user;

      for(const d of data){
        const isOwner = currentUser && currentUser.email === d.owner.email;
        const card = document.createElement('article');
        card.className='listing';
        
        const img = document.createElement('img');
        img.alt = d.title;
        img.src = d.image || 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect width="100%" height="100%" fill="%230f172a"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%2394a3b8" font-family="Inter" font-size="16">No Image Available</text></svg>`);
        
        const info = document.createElement('div'); info.className='info';
        
        const contactBtn = isOwner 
          ? `<button class="btn danger" data-action="remove" data-id="${d.id}" style="width:100%">Remove Listing</button>`
          : `<button class="btn brand" data-action="contact" data-id="${d.id}">Contact Seller</button>`;

        const exchangeBtn = !isOwner && d.type !== 'Buy'
          ? `<button class="btn ghost" data-action="exchange" data-id="${d.id}" title="Propose an Exchange">Exchange</button>`
          : '';

        const priceDisplay = d.type === 'Exchange' 
          ? '<span class="price" style="color:var(--warn)">EXCHANGE</span>'
          : d.type === 'Buy'
          ? '<span class="price" style="color:var(--brand-2)">WANT TO BUY</span>'
          : `<span class="price">â‚¹ ${Number(d.price).toLocaleString()}</span>`;

        info.innerHTML = `
          <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:4px">
            <h3>${escapeHtml(d.title)}</h3>
            <span class="tag" style="background:${d.type==='Sell'?'#10b981':'#6366f1'}">${d.type}</span>
          </div>
          <div class="fine">${escapeHtml(d.author || 'â€”')} â€¢ ${escapeHtml(d.subject || 'â€”')}</div>
          ${priceDisplay}
          <div class="meta" style="margin-top:4px">
            <span class="pill">${d.condition}</span>
            <span class="pill" title="Owner">ðŸ‘¤ ${escapeHtml(d.owner.name.split(' ')[0])}</span>
            <span class="pill" title="Posted Date">${new Date(d.createdAt).toLocaleDateString()}</span>
          </div>
          <div class="fine" style="margin-top:10px;overflow:hidden;text-overflow:ellipsis;max-height:4.5em;">${escapeHtml(d.description||'')}</div>
          
          <div class="actions">
            ${contactBtn}
            ${exchangeBtn}
          </div>
        `;
        card.appendChild(img); card.appendChild(info);
        elListings.appendChild(card);
      }
    }

    // Sanitize basic text
    function escapeHtml(s){ return (s+"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])) }

    // ----------------- Contact / Messages -----------------
    const contactModal = qs('#contactModal');
    const contactInfo = qs('#contactInfo');
    const closeContact = qs('#closeContact');
    const msgForm = qs('#msgForm');
    const msgText = qs('#msgText');
    const mailtoLink = qs('#mailtoLink');
    const thread = qs('#thread');
    let currentListing = null;

    document.body.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const {action,id} = btn.dataset;
      if(!action) return;
      const list = store.listings;
      const item = list.find(x=>x.id===id);
      if(!item) return;

      if(action==='remove'){
        if(confirm(`Are you sure you want to remove the listing for "${item.title}"?`)){
          const idx = list.findIndex(x=>x.id===id); list.splice(idx,1); store.listings = list; render();
        }
      }
      if(action==='contact' || action==='exchange'){
        if(!store.user) {
          alert('Please sign in to contact the seller.');
          openModal(loginModal);
          return;
        }

        currentListing = item;
        
        let subject = `Enquiry: ${item.title}`;
        let body = `Hi ${item.owner.name},\n\nI am interested in your listing: ${item.title} (${item.type}).\nPrice: â‚¹${item.price}\n\nâ€” ${store.user.name}`;

        if(action==='exchange'){
          subject = `Exchange Proposal: ${item.title}`;
          body = `Hi ${item.owner.name},\n\nWould you consider an exchange for ${item.title}? I can offer â€¦\n\nâ€” ${store.user.name}`;
          msgText.value = 'Hi! I can exchange with â€¦ (book title/condition).';
        } else {
          msgText.value = '';
        }
        
        contactInfo.textContent = `Seller: ${item.owner.name} (${item.owner.email})`;
        mailtoLink.href = `mailto:${encodeURIComponent(item.owner.email)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        
        renderThread(item);
        openModal(contactModal);
      }
    })

    closeContact.addEventListener('click',()=>closeModal(contactModal))

    msgForm.addEventListener('submit', e=>{
      e.preventDefault();
      const text = msgText.value.trim(); if(!text || !currentListing) return;
      
      const me = store.user || {name:'Guest', email:'guest@example.com'};
      if (me.name === 'Guest') {
        alert('You must sign in to send in-app messages.');
        openModal(loginModal);
        return;
      }

      const list = store.listings;
      const item = list.find(x=>x.id===currentListing.id); if(!item) return;
      
      item.msgs.push({ by:me.name, text, ts:Date.now() });
      store.listings = list; msgText.value=''; renderThread(item);
    })

    function renderThread(item){
      if(!item.msgs?.length){ thread.innerHTML = '<div class="fine" style="text-align:center">No messages yet. Use Email Draft or send an inâ€‘app message.</div>'; return }
      thread.innerHTML = item.msgs.map(m=>`<div class="msg-item"><div class="sender">${escapeHtml(m.by)}</div><div>${escapeHtml(m.text)}</div><div class="fine" style="margin-top:4px">${new Date(m.ts).toLocaleString()}</div></div>`).join('');
    }

    // ----------------- About Modal -----------------
    const aboutBtn = qs('#aboutBtn');
    const aboutModal = qs('#aboutModal');
    const closeAbout = qs('#closeAbout');
    aboutBtn.addEventListener('click',()=>openModal(aboutModal));
    closeAbout.addEventListener('click',()=>closeModal(aboutModal));

    // ----------------- Seed Demo Data (first run) -----------------
    (function seed(){
      if(store.listings.length) return;
      const demo = [
        {type:'Sell', price:350, title:'Discrete Mathematics and Its Applications', author:'Kenneth Rosen', subject:'CSE / Discrete Math', condition:'Good', description:'6th Ed. A few highlights. Great condition, barely used. Price negotiable.', image:'', owner:{name:'Arjun Mehta', email:'arjun@college.edu'}},
        {type:'Exchange', price:0, title:'Operating System Concepts', author:'Silberschatz', subject:'CSE / OS', condition:'Fair', description:'7th Edition. Heavy highlights, but fully functional. Willing to swap for a DBMS book or a Python book.', image:'', owner:{name:'Sneha Rao', email:'sneha@college.edu'}},
        {type:'Buy', price:200, title:'Python Crash Course', author:'Eric Matthes', subject:'Programming', condition:'Good', description:'Looking for an affordable, second-hand copy of the 2nd Edition. Can pay up to â‚¹250.', image:'', owner:{name:'Rahul Verma', email:'rahul@college.edu'}}
      ];
      store.listings = demo.map(x=>({id:'L'+Math.random().toString(36).slice(2,9), createdAt:Date.now()-Math.floor(Math.random()*1e7), msgs:[], image:'', ...x}));
    })();

    // ----------------- Init -----------------
    updateAuthUI();
    render();
  </script>
</body>
</html>
