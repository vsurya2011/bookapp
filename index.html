<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Used Books Hub — College Buy/Sell/Exchange</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --card:#111827; /* gray-900 */
      --muted:#94a3b8; /* slate-400 */
      --text:#e5e7eb; /* gray-200 */
      --brand:#22c55e; /* green-500 */
      --brand-2:#60a5fa; /* blue-400 */
      --danger:#ef4444; /* red-500 */
      --warn:#f59e0b; /* amber-500 */
      --ok:#10b981; /* emerald-500 */
      --chip:#1f2937; /* gray-800 */
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;background-color:var(--bg);color:var(--text);line-height:1.6}
    
    .container{max-width:1200px;margin:0 auto;padding:1rem}
    .header{display:flex;justify-content:space-between;align-items:center;padding:1rem 0;border-bottom:1px solid var(--chip)}
    .logo{font-size:1.8rem;font-weight:700;color:var(--brand);display:flex;align-items:center;gap:0.5rem}
    .logo-icon{color:var(--brand-2)}

    .nav-btn{background:var(--brand);color:var(--bg);border:none;padding:0.75rem 1.25rem;border-radius:var(--radius);cursor:pointer;font-weight:600;transition:transform 0.1s, background 0.2s}
    .nav-btn:hover{background:var(--ok);transform:translateY(-1px)}
    .nav-btn:active{transform:translateY(0)}

    /* Card Styling */
    .card-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:1.5rem;padding:1.5rem 0}
    .card{background-color:var(--card);border-radius:var(--radius);padding:1.5rem;box-shadow:var(--shadow);display:flex;flex-direction:column;transition:transform 0.2s}
    .card:hover{transform:translateY(-3px)}
    .card-header{margin-bottom:1rem;display:flex;justify-content:space-between;align-items:flex-start}
    .card-type{font-size:0.85rem;font-weight:700;padding:0.25rem 0.75rem;border-radius:9999px;color:var(--text)}
    .card-type[data-type="Sell"]{background-color:var(--danger)}
    .card-type[data-type="Exchange"]{background-color:var(--warn)}
    .card-type[data-type="Buy"]{background-color:var(--brand)}
    .card-price{font-size:1.5rem;font-weight:700;color:var(--brand-2)}
    .card-price[data-type="Exchange"]{color:var(--warn)}
    .card-price[data-type="Buy"]{color:var(--brand)}
    .card-title{font-size:1.25rem;font-weight:600;margin:0.5rem 0 0.25rem 0;color:var(--text)}
    .card-author, .card-subject{font-size:0.9rem;color:var(--muted);margin:0}
    .card-condition{font-size:0.9rem;font-style:italic;color:var(--ok);margin-top:0.5rem}
    .card-condition[data-condition="Fair"]{color:var(--warn)}
    .card-condition[data-condition="Poor"]{color:var(--danger)}
    .card-footer{margin-top:auto;padding-top:1rem;border-top:1px solid var(--chip);font-size:0.8rem;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    .card-owner-btn{background:var(--chip);color:var(--text);border:none;padding:0.5rem 0.75rem;border-radius:8px;cursor:pointer;font-weight:500;transition:background 0.2s}
    .card-owner-btn:hover{background:rgba(255,255,255,0.1)}

    /* Modal Styling */
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.7);display:none;justify-content:center;align-items:center;z-index:1000}
    .modal-content{background-color:var(--bg);padding:2rem;border-radius:var(--radius);width:90%;max-width:500px;box-shadow:var(--shadow);position:relative}
    .modal-close{position:absolute;top:1rem;right:1rem;background:none;border:none;color:var(--muted);font-size:1.5rem;cursor:pointer;line-height:1}
    .modal h2{margin-top:0;color:var(--brand)}

    /* Form Styling */
    .form-group{margin-bottom:1rem}
    .form-group label{display:block;margin-bottom:0.4rem;font-weight:500;color:var(--text)}
    .form-group input, .form-group select, .form-group textarea{width:100%;padding:0.75rem;border-radius:8px;border:1px solid var(--chip);background-color:var(--chip);color:var(--text);font-size:1rem}
    .form-group textarea{resize:vertical;min-height:100px}
    .form-actions{display:flex;justify-content:flex-end;gap:1rem}
    .form-btn-primary{background:var(--brand);color:var(--bg);border:none;padding:0.75rem 1.25rem;border-radius:var(--radius);cursor:pointer;font-weight:600;transition:background 0.2s}
    .form-btn-secondary{background:var(--chip);color:var(--text);border:1px solid var(--muted);padding:0.75rem 1.25rem;border-radius:var(--radius);cursor:pointer;font-weight:600;transition:background 0.2s}
    .form-btn-primary:hover{background:var(--ok)}
    .form-btn-secondary:hover{background:var(--card)}

    /* Listing Modal Styling */
    .listing-modal-content{max-width:700px}
    .listing-details{display:grid;grid-template-columns:1fr;gap:1rem;margin-top:1rem}
    @media (min-width:600px){
      .listing-details{grid-template-columns:1fr 2fr}
    }
    .listing-info h3{color:var(--brand-2);border-bottom:1px solid var(--chip);padding-bottom:0.5rem;margin-bottom:0.5rem}
    .listing-info p{margin:0.5rem 0}
    .listing-info span{font-weight:600;color:var(--text)}
    .listing-image-placeholder{background-color:var(--chip);height:200px;border-radius:8px;display:flex;justify-content:center;align-items:center;color:var(--muted)}
    
    .chat-section{margin-top:1.5rem;padding-top:1rem;border-top:1px solid var(--chip)}
    .chat-messages{max-height:200px;overflow-y:auto;background-color:var(--chip);padding:1rem;border-radius:8px;margin-bottom:1rem}
    .chat-message{padding:0.5rem;margin-bottom:0.5rem;border-radius:8px;max-width:80%;}
    .chat-message.system{background-color:rgba(255, 255, 255, 0.05);color:var(--muted);font-style:italic;font-size:0.9rem}
    .chat-message.user{background-color:var(--brand-2);color:#fff;margin-left:auto}
    .chat-message.other{background-color:var(--card);color:var(--text);margin-right:auto}
    .chat-input-group{display:flex;gap:0.5rem}
    .chat-input-group input{flex-grow:1}

    /* Message Box for Alerts */
    .message-box{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.9);background-color:var(--card);padding:2rem;border-radius:var(--radius);box-shadow:var(--shadow);z-index:1010;display:none;flex-direction:column;gap:1rem;opacity:0;transition:all 0.3s ease-out;min-width:300px}
    .message-box.show{display:flex;transform:translate(-50%,-50%) scale(1);opacity:1}
    .message-box h3{color:var(--brand);margin:0;border-bottom:1px solid var(--chip);padding-bottom:0.5rem}
    .message-box p{margin:0;color:var(--text)}
    .message-box button{align-self:flex-end;background:var(--brand);color:var(--bg);border:none;padding:0.5rem 1rem;border-radius:8px;cursor:pointer}

    /* Utility */
    .text-center{text-align:center}
    .mt-4{margin-top:1rem}
    .hidden{display:none !important}
  </style>
  <!-- Load Tailwind for icons (used for the book icon) -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>

  <div class="container">
    <header class="header">
      <div class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" class="logo-icon h-8 w-8" viewBox="0 0 24 24" fill="currentColor"><path d="M21 4H7v12h14V4zm-2 2v8H9V6h10zM5 18H3V2h2v16zm18 2H5v2h18v-2z"></path></svg>
        <span>Used Books Hub</span>
      </div>
      <nav>
        <button id="addListingBtn" class="nav-btn">Post Listing</button>
        <button id="aboutBtn" class="nav-btn" style="background:var(--chip)">About</button>
      </nav>
    </header>

    <!-- Main Content Area: Listing Grid -->
    <main id="listingGrid" class="card-grid">
      <!-- Listings will be injected here -->
    </main>

  </div>

  <!-- ----------------- Modals ----------------- -->

  <!-- 1. Add/Edit Listing Modal -->
  <div id="listingModal" class="modal">
    <div class="modal-content">
      <button id="closeListing" class="modal-close">&times;</button>
      <h2 id="modalTitle">Post a New Listing</h2>
      <form id="listingForm">
        <input type="hidden" id="listingId" />
        <div class="form-group">
          <label for="type">Listing Type</label>
          <select id="type" required>
            <option value="Sell">Sell</option>
            <option value="Exchange">Exchange</option>
            <option value="Buy">Want to Buy (WTB)</option>
          </select>
        </div>

        <div class="form-group">
          <label for="price">Price (₹, 0 for Exchange)</label>
          <input type="number" id="price" min="0" value="0" required />
        </div>

        <div class="form-group">
          <label for="title">Book Title</label>
          <input type="text" id="title" required maxlength="100" />
        </div>

        <div class="form-group">
          <label for="author">Author</label>
          <input type="text" id="author" required maxlength="100" />
        </div>

        <div class="form-group">
          <label for="subject">Subject / Course</label>
          <input type="text" id="subject" required maxlength="50" placeholder="e.g., CSE / DBMS, Economics 101" />
        </div>

        <div class="form-group">
          <label for="condition">Condition</label>
          <select id="condition" required>
            <option value="New">New</option>
            <option value="Good">Good</option>
            <option value="Fair">Fair</option>
            <option value="Poor">Poor</option>
          </select>
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" maxlength="500" placeholder="e.g., Edition, highlights, what you're looking for..."></textarea>
        </div>
        
        <!-- Image input (currently non-functional placeholder) -->
        <div class="form-group">
          <label for="image">Image (Optional)</label>
          <input type="file" id="image" accept="image/*" disabled />
          <small style="color:var(--muted)">Image upload feature is currently disabled.</small>
        </div>

        <div class="form-actions">
          <button type="button" id="deleteListingBtn" class="form-btn-secondary hidden" style="background:var(--danger)">Delete</button>
          <button type="submit" class="form-btn-primary">Save Listing</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 2. View Listing Modal (Details and Chat) -->
  <div id="viewModal" class="modal">
    <div class="modal-content listing-modal-content">
      <button id="closeView" class="modal-close">&times;</button>
      <h2 id="viewTitle" class="text-center">Book Title Placeholder</h2>

      <div class="listing-details">
        <div class="listing-image">
          <div id="viewImagePlaceholder" class="listing-image-placeholder">
            No Image Provided
          </div>
        </div>
        <div class="listing-info">
          <p><span>Type:</span> <span id="viewType"></span></p>
          <p><span>Price:</span> <span id="viewPrice" style="color:var(--brand-2)"></span></p>
          <p><span>Author:</span> <span id="viewAuthor"></span></p>
          <p><span>Subject:</span> <span id="viewSubject"></span></p>
          <p><span>Condition:</span> <span id="viewCondition"></span></p>
          
          <h3>Description</h3>
          <p id="viewDescription"></p>
          
          <h3>Seller/Requester</h3>
          <p><span>Owner:</span> <span id="viewOwnerName"></span> (<span id="viewOwnerEmail"></span>)</p>
          <p><span>Posted:</span> <span id="viewCreatedAt"></span></p>
          
          <div id="viewActions" class="form-actions mt-4">
            <!-- Edit/Contact buttons dynamically injected -->
          </div>
        </div>
      </div>

      <!-- Chat Section -->
      <div id="chatContainer" class="chat-section hidden">
        <h3>Contact <span id="chatTargetName"></span></h3>
        <div id="chatMessages" class="chat-messages">
          <!-- Messages will be injected here -->
        </div>
        <div class="chat-input-group">
          <input type="text" id="chatInput" placeholder="Type your message..." maxlength="150">
          <button id="sendChatBtn" class="form-btn-primary">Send</button>
        </div>
        <small id="chatStatus" class="mt-4" style="color:var(--muted)"></small>
      </div>

    </div>
  </div>

  <!-- 3. About Modal -->
  <div id="aboutModal" class="modal">
    <div class="modal-content">
      <button id="closeAbout" class="modal-close">&times;</button>
      <h2>About Used Books Hub</h2>
      <p>This is a demonstration application for students to buy, sell, or exchange used textbooks and course materials.</p>
      <p>It's built entirely in a single HTML file using vanilla JavaScript and CSS for a lightweight, fast user experience.</p>
      <p><strong>Note:</strong> Data is currently stored only in your browser's local storage and is not shared with other users. The chat function is simulated.</p>
      <p style="color:var(--brand-2)">Version 1.0.0 - November 2025</p>
    </div>
  </div>

  <!-- 4. Universal Message Box -->
  <div id="messageBox" class="message-box">
    <h3 id="msgTitle"></h3>
    <p id="msgBody"></p>
    <button id="msgCloseBtn">OK</button>
  </div>

  <script>
    // Utility for easy DOM selection
    const qs = selector => document.querySelector(selector);
    const qsa = selector => document.querySelectorAll(selector);

    // ----------------- State Management (Local Storage) -----------------
    const STORE_KEY = 'booksHubListings';

    const store = {
      // Load or initialize listings from Local Storage
      get listings() {
        try {
          const data = localStorage.getItem(STORE_KEY);
          return data ? JSON.parse(data) : [];
        } catch (e) {
          console.error("Error loading state from localStorage:", e);
          return [];
        }
      },
      // Save listings to Local Storage
      set listings(data) {
        try {
          localStorage.setItem(STORE_KEY, JSON.stringify(data));
          renderListings(); // Re-render whenever data changes
        } catch (e) {
          console.error("Error saving state to localStorage:", e);
        }
      }
    };

    // User simulation (for owner checks and chat)
    const currentUser = {
      id: 'U12345',
      name: 'Current User',
      email: 'user@college.edu'
    };

    // ----------------- Utility Functions -----------------

    // Show a custom message box instead of alert()
    function showMessage(title, body) {
      qs('#msgTitle').textContent = title;
      qs('#msgBody').textContent = body;
      qs('#messageBox').classList.add('show');
    }

    // Modal open/close logic
    function openModal(modal) {
      modal.style.display = 'flex';
      // Add event listener to close modal when clicking outside
      setTimeout(() => { // Small delay to prevent immediate closing from initial click
        modal.onclick = (e) => {
          if (e.target === modal) closeModal(modal);
        };
      }, 50);
    }

    function closeModal(modal) {
      modal.style.display = 'none';
      modal.onclick = null; // Remove the click listener
    }
    
    // Format timestamp to readable date
    function formatDate(timestamp) {
      if (!timestamp) return 'N/A';
      return new Date(timestamp).toLocaleDateString('en-US', {
        year: 'numeric', month: 'short', day: 'numeric'
      });
    }

    // ----------------- Rendering -----------------

    // Renders all listing cards to the main grid
    function renderListings() {
      const grid = qs('#listingGrid');
      grid.innerHTML = ''; // Clear existing cards

      if (store.listings.length === 0) {
        grid.innerHTML = `<div class="text-center" style="grid-column: 1 / -1; color: var(--muted);">
                            <p>No listings found. Be the first to post!</p>
                            <button id="addListingBtnEmpty" class="nav-btn" style="margin-top: 1rem;">Post Listing</button>
                          </div>`;
        qs('#addListingBtnEmpty').addEventListener('click', () => openModal(qs('#listingModal')));
        return;
      }

      store.listings.forEach(listing => {
        const typeColor = listing.type === 'Sell' ? 'var(--danger)' : listing.type === 'Exchange' ? 'var(--warn)' : 'var(--brand)';
        const priceText = listing.type === 'Exchange' ? 'FREE / Exchange' : `₹${listing.price}`;

        const card = document.createElement('div');
        card.classList.add('card');
        card.dataset.id = listing.id; // Store ID for click listener
        card.innerHTML = `
          <div class="card-header">
            <span class="card-type" data-type="${listing.type}">${listing.type}</span>
            <span class="card-price" data-type="${listing.type}">${priceText}</span>
          </div>
          <h3 class="card-title">${listing.title}</h3>
          <p class="card-author">by ${listing.author}</p>
          <p class="card-subject">${listing.subject}</p>
          <p class="card-condition" data-condition="${listing.condition}">${listing.condition}</p>
          <footer class="card-footer">
            <span>${formatDate(listing.createdAt)}</span>
            <button class="card-owner-btn view-btn" data-id="${listing.id}">View Details</button>
          </footer>
        `;
        grid.appendChild(card);
      });

      // Attach view listener to the new buttons
      qsa('.view-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation(); // Prevent card click if implemented later
          const listingId = e.target.dataset.id;
          viewListingDetails(listingId);
        });
      });
    }

    // ----------------- Listing Modal Logic -----------------

    const listingModal = qs('#listingModal');
    const listingForm = qs('#listingForm');

    // Reset form fields
    function resetForm() {
      listingForm.reset();
      qs('#listingId').value = '';
      qs('#modalTitle').textContent = 'Post a New Listing';
      qs('#deleteListingBtn').classList.add('hidden');
      qs('#price').value = 0;
    }

    // Open form to add new listing
    qs('#addListingBtn').addEventListener('click', () => {
      resetForm();
      openModal(listingModal);
    });

    // Close listing modal
    qs('#closeListing').addEventListener('click', () => closeModal(listingModal));

    // Fill form for editing an existing listing
    function editListing(listingId) {
      const listing = store.listings.find(l => l.id === listingId);
      if (!listing || listing.owner.id !== currentUser.id) {
        showMessage('Error', 'You do not have permission to edit this listing.');
        return;
      }

      qs('#listingId').value = listing.id;
      qs('#modalTitle').textContent = 'Edit Listing';
      qs('#type').value = listing.type;
      qs('#price').value = listing.price || 0;
      qs('#title').value = listing.title;
      qs('#author').value = listing.author;
      qs('#subject').value = listing.subject;
      qs('#condition').value = listing.condition;
      qs('#description').value = listing.description;
      
      qs('#deleteListingBtn').classList.remove('hidden');

      openModal(listingModal);
    }

    // Handle form submission (Add or Edit)
    listingForm.addEventListener('submit', (e) => {
      e.preventDefault();

      const id = qs('#listingId').value;
      const type = qs('#type').value;
      const price = parseInt(qs('#price').value) || 0;
      const title = qs('#title').value.trim();
      const author = qs('#author').value.trim();
      const subject = qs('#subject').value.trim();
      const condition = qs('#condition').value;
      const description = qs('#description').value.trim();

      const newListing = {
        type, price, title, author, subject, condition, description,
        image: '', // Image placeholder
        owner: currentUser,
      };

      let currentListings = store.listings;

      if (id) {
        // Edit existing listing
        store.listings = currentListings.map(l => 
          l.id === id ? { ...l, ...newListing, msgs: l.msgs || [] } : l
        );
        showMessage('Success', 'Listing updated successfully!');
      } else {
        // Add new listing
        newListing.id = 'L' + Math.random().toString(36).slice(2, 9);
        newListing.createdAt = Date.now();
        newListing.msgs = []; // Initialize message array for new listing
        store.listings = [newListing, ...currentListings];
        showMessage('Success', 'New listing posted!');
      }

      closeModal(listingModal);
      resetForm();
    });

    // Delete listing logic
    qs('#deleteListingBtn').addEventListener('click', () => {
      const listingId = qs('#listingId').value;
      if (!listingId) return;

      const confirmed = confirm('Are you sure you want to delete this listing? This action cannot be undone.'); // Using built-in confirm for simplicity, will replace with custom modal if needed

      if (confirmed) {
        store.listings = store.listings.filter(l => l.id !== listingId);
        closeModal(listingModal);
        showMessage('Deleted', 'Listing has been successfully deleted.');
      }
    });

    // ----------------- View Listing Modal Logic -----------------

    const viewModal = qs('#viewModal');
    const chatContainer = qs('#chatContainer');
    const chatMessagesContainer = qs('#chatMessages');
    const chatInput = qs('#chatInput');
    const sendChatBtn = qs('#sendChatBtn');
    let currentViewingListingId = null;

    // Close view modal
    qs('#closeView').addEventListener('click', () => closeModal(viewModal));
    qs('#msgCloseBtn').addEventListener('click', () => qs('#messageBox').classList.remove('show'));

    // Renders chat messages for the current listing
    function renderChatMessages(listing) {
      chatMessagesContainer.innerHTML = '';
      const ownerId = listing.owner.id;
      const otherUser = listing.msgs.length > 0 ? listing.msgs.find(m => m.senderId !== ownerId) : null;
      
      if (listing.msgs.length === 0) {
          chatMessagesContainer.innerHTML = `<div class="chat-message system text-center">No messages yet. Start the conversation!</div>`;
      }

      listing.msgs.forEach(msg => {
        const msgEl = document.createElement('div');
        msgEl.classList.add('chat-message');
        
        let senderName;
        let msgClass;

        if (msg.senderId === currentUser.id) {
          senderName = 'You';
          msgClass = 'user';
        } else if (msg.senderId === ownerId) {
          senderName = listing.owner.name;
          msgClass = 'other';
        } else {
          // Fallback for an 'other' user who isn't the owner
          senderName = msg.senderName;
          msgClass = 'other';
        }
        
        msgEl.classList.add(msgClass);
        msgEl.innerHTML = `<strong>${senderName}:</strong> ${msg.text}`;
        chatMessagesContainer.appendChild(msgEl);
      });

      // Scroll to the bottom of the chat
      chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
    }

    // Displays the selected listing details
    function viewListingDetails(listingId) {
      const listing = store.listings.find(l => l.id === listingId);
      if (!listing) return; // Should not happen

      currentViewingListingId = listingId;
      const isOwner = listing.owner.id === currentUser.id;

      // Fill in details
      qs('#viewTitle').textContent = listing.title;
      qs('#viewType').textContent = listing.type;
      qs('#viewPrice').textContent = listing.type === 'Exchange' ? 'FREE / Exchange' : `₹${listing.price}`;
      qs('#viewAuthor').textContent = listing.author;
      qs('#viewSubject').textContent = listing.subject;
      qs('#viewCondition').textContent = listing.condition;
      qs('#viewDescription').textContent = listing.description;
      qs('#viewOwnerName').textContent = listing.owner.name;
      qs('#viewOwnerEmail').textContent = listing.owner.email;
      qs('#viewCreatedAt').textContent = formatDate(listing.createdAt);
      
      // Dynamic Action Buttons
      const viewActions = qs('#viewActions');
      viewActions.innerHTML = '';

      if (isOwner) {
        // Owner actions
        const editBtn = document.createElement('button');
        editBtn.className = 'form-btn-primary';
        editBtn.textContent = 'Edit Listing';
        editBtn.onclick = () => {
          closeModal(viewModal);
          editListing(listingId);
        };
        viewActions.appendChild(editBtn);
        chatContainer.classList.add('hidden'); // Owner doesn't chat with themselves
        qs('#chatStatus').textContent = 'This is your listing.';
      } else {
        // Buyer/Interested Party actions
        const contactBtn = document.createElement('button');
        contactBtn.className = 'form-btn-primary';
        contactBtn.textContent = 'Start Conversation';
        contactBtn.onclick = () => {
            chatContainer.classList.remove('hidden');
            contactBtn.classList.add('hidden'); // Hide button once conversation is started
        };
        viewActions.appendChild(contactBtn);

        // Show/Hide chat section based on previous messages
        const hasMessages = listing.msgs && listing.msgs.length > 0;
        if (hasMessages) {
            chatContainer.classList.remove('hidden');
            contactBtn.classList.add('hidden');
        } else {
            chatContainer.classList.add('hidden');
            contactBtn.classList.remove('hidden');
        }

        qs('#chatTargetName').textContent = listing.owner.name;
        qs('#chatStatus').textContent = 'Messages are private and only visible to you and the listing owner.';
      }
      
      // Render messages and open modal
      renderChatMessages(listing);
      openModal(viewModal);
      
      // Ensure chat input is cleared
      chatInput.value = '';
    }
    
    // Handle sending a new chat message
    sendChatBtn.addEventListener('click', () => {
      const text = chatInput.value.trim();
      if (!text || !currentViewingListingId) return;

      const listingIndex = store.listings.findIndex(l => l.id === currentViewingListingId);
      if (listingIndex === -1) return;

      const listing = store.listings[listingIndex];
      const isOwner = listing.owner.id === currentUser.id;

      if (isOwner) {
         showMessage('Error', 'You cannot send chat messages on your own listing.');
         return;
      }

      // Add new message to the listing's messages array
      const newMessage = {
        id: 'M' + Math.random().toString(36).slice(2, 9),
        senderId: currentUser.id,
        senderName: currentUser.name,
        timestamp: Date.now(),
        text: text
      };
      
      listing.msgs.push(newMessage);

      // Create a copy of the listings array and update the modified listing
      let updatedListings = [...store.listings];
      updatedListings[listingIndex] = listing;
      
      // Save updated listings (triggers re-render)
      store.listings = updatedListings;

      // Re-render chat (which happens automatically via store.listings setter, but we call it explicitly to be safe)
      renderChatMessages(listing);
      
      chatInput.value = ''; // Clear input
    });

    // ----------------- About Modal -----------------
    const aboutBtn = qs('#aboutBtn');
    const aboutModal = qs('#aboutModal');
    const closeAbout = qs('#closeAbout');
    aboutBtn.addEventListener('click',()=>openModal(aboutModal));
    closeAbout.addEventListener('click',()=>closeModal(aboutModal));

    // ----------------- Seed Demo Data (first run) -----------------
    (function seed(){
      if(store.listings.length) return;
      const demo = [
        {type:'Sell', price:350, title:'Discrete Mathematics and Its Applications', author:'Kenneth Rosen', subject:'CSE / Discrete Math', condition:'Good', description:'6th Ed. A few highlights.', image:'', owner:{id:'U98765', name:'Arjun Mehta', email:'arjun@college.edu'}},
        {type:'Exchange', price:0, title:'Operating System Concepts', author:'Silberschatz', subject:'CSE / OS', condition:'Fair', description:'Willing to swap for DBMS book.', image:'', owner:{id:'U54321', name:'Sneha Rao', email:'sneha@college.edu'}},
        {type:'Buy', price:200, title:'Python Crash Course', author:'Eric Matthes', subject:'Programming', condition:'Good', description:'Looking for an affordable copy.', image:'', owner:{id:'U13579', name:'Rahul Verma', email:'rahul@college.edu'}},
        {type:'Sell', price:1500, title:'Introduction to Algorithms', author:'Cormen, Leiserson, Rivest, Stein', subject:'CSE / Algorithms', condition:'Good', description:'Original US edition. Minimal wear.', image:'', owner:{id:currentUser.id, name:currentUser.name, email:currentUser.email}}, // Owned by current user
      ];
      store.listings = demo.map(x=>({id:'L'+Math.random().toString(36).slice(2,9), createdAt:Date.now()-Math.floor(Math.random()*1e7), msgs:[
        ...(x.title === 'Python Crash Course' ? [{id:'M1', senderId:currentUser.id, senderName:currentUser.name, timestamp:Date.now()-5000000, text:'Is this still available?'}] : []),
      ], image:'', ...x}));
    })(); // Execute seeding function

    // ----------------- Initialization -----------------
    // Initial rendering of the listings when the script loads
    renderListings();
  </script>
</body>
</html>
