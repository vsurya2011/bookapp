<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Book Hub ‚Äî Buy, Sell, Exchange</title>
  <style>
    /* ----------------- Theme Variables ----------------- */
    :root{
      /* Dark Theme Default */
      --bg: #0f172a; --card: #1e293b; --border: #334155; --text: #f1f5f9; --muted: #94a3b8;
      --brand: #34d399; --brand-hover: #10b981; --brand-2: #6366f1;
      --shadow: 0 10px 30px rgba(0,0,0,0.5);
      --msg-me: #34d399; --msg-them: #334155;
    }
    .light-theme {
      --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0; --text: #0f172a; --muted: #64748b;
      --brand: #10b981; --brand-hover: #059669; --brand-2: #4f46e5;
      --shadow: 0 4px 12px rgba(0,0,0,0.1);
      --msg-me: #10b981; --msg-them: #e2e8f0;
    }

    /* ----------------- Reset & Base Styles ----------------- */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    body { background-color: var(--bg); color: var(--text); transition: background-color 0.3s, color 0.3s; min-height: 100vh; display: flex; flex-direction: column; }
    
    h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 0.5rem; }
    h2 { font-size: 1.4rem; font-weight: 600; }
    h3 { font-size: 1.1rem; font-weight: 600; }
    p { line-height: 1.6; }
    a { color: var(--brand); text-decoration: none; }
    
    /* ----------------- Header ----------------- */
    header {
      background-color: var(--card); border-bottom: 1px solid var(--border);
      padding: 0 2rem; height: 70px; display: flex; justify-content: space-between; align-items: center;
      box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100;
    }
    #logo { font-size: 1.5rem; font-weight: 700; color: var(--brand); cursor: pointer; display: flex; align-items: center; gap: 10px; }
    
    /* Navigation */
    nav { display: flex; align-items: center; gap: 2rem; }
    #navLinks { display: flex; gap: 1.5rem; }
    .nav-link { font-size: 0.95rem; font-weight: 500; color: var(--muted); cursor: pointer; padding: 0.5rem 0; transition: color 0.2s; position: relative; }
    .nav-link:hover, .nav-link.active { color: var(--text); }
    .nav-link.active::after { content:''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--brand); }

    /* Auth & Controls */
    #authControls { display: flex; align-items: center; gap: 1rem; }
    #themeToggle { background: none; border: 1px solid var(--border); color: var(--muted); cursor: pointer; padding: 0.4rem; border-radius: 6px; display: flex; }
    
    /* Mobile Menu Button */
    #mobileMenuBtn { display: none; background: none; border: none; color: var(--text); cursor: pointer; font-size: 1.5rem; }

    /* ----------------- Main Layout ----------------- */
    main { flex-grow: 1; padding: 2rem; width: 100%; max-width: 1200px; margin: 0 auto; }
    section { padding: 1rem 0; animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .hidden { display: none !important; }

    /* ----------------- Dashboard Grid ----------------- */
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; margin-top: 20px; }
    
    .stat-card { background-color: var(--card); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
    .stat-card .value { font-size: 2.5rem; font-weight: 700; color: var(--brand); margin: 10px 0; }

    /* Listing Card */
    .listing-card { background-color: var(--card); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; border: 1px solid var(--border); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; height: 100%; }
    .listing-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); }
    .listing-card img { width: 100%; height: 220px; object-fit: cover; border-bottom: 1px solid var(--border); }
    .listing-card .info { padding: 1.25rem; display: flex; flex-direction: column; flex-grow: 1; gap: 8px; }
    .listing-card h3 { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .listing-card .row { display: flex; justify-content: space-between; align-items: center; }
    
    /* Tags & Price */
    .tag { padding: 0.2rem 0.6rem; background-color: var(--border); border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .price { font-size: 1.25rem; font-weight: 700; color: var(--brand); }
    .type-exchange { color: var(--brand-2); font-weight: 700; font-size: 0.9rem; }
    
    /* ----------------- Forms & Inputs ----------------- */
    .filters { background: var(--card); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 2rem; display: flex; gap: 1rem; flex-wrap: wrap; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500; }
    input, select, textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background-color: var(--bg); color: var(--text); font-size: 1rem; }
    input:focus, select:focus, textarea:focus { border-color: var(--brand); outline: none; box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.2); }
    
    /* Buttons */
    .btn { padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .btn.brand { background-color: var(--brand); color: #fff; }
    .btn.brand:hover { background-color: var(--brand-hover); }
    .btn.ghost { background: transparent; border: 1px solid var(--brand); color: var(--brand); }
    .btn.ghost:hover { background: rgba(52, 211, 153, 0.1); }
    .btn.danger { background-color: #ef4444; color: white; }
    .btn-full { width: 100%; }

    /* ----------------- Detail View (Responsive) ----------------- */
    .detail-container { display: grid; grid-template-columns: 2fr 3fr; gap: 40px; }
    .detail-img-box { background: var(--bg); border-radius: 12px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; overflow: hidden; max-height: 500px; }
    .detail-img-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .detail-info { display: flex; flex-direction: column; gap: 15px; }
    .contact-box { background: rgba(52, 211, 153, 0.1); border: 1px solid var(--brand); padding: 15px; border-radius: 8px; color: var(--text); }

    /* Chat Styling */
    .chat-box { border: 1px solid var(--border); border-radius: 12px; background: var(--bg); height: 350px; display: flex; flex-direction: column; overflow: hidden; margin-top: 20px; }
    .chat-messages { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
    .msg-bubble { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 0.95rem; line-height: 1.4; position: relative; word-wrap: break-word; }
    .msg-bubble.sent { align-self: flex-end; background-color: var(--msg-me); color: #fff; border-bottom-right-radius: 2px; }
    .msg-bubble.received { align-self: flex-start; background-color: var(--msg-them); color: var(--text); border-bottom-left-radius: 2px; }
    .msg-meta { font-size: 0.7rem; opacity: 0.8; margin-top: 4px; display: block; text-align: right; }
    .chat-input-area { padding: 10px; background: var(--card); border-top: 1px solid var(--border); display: flex; gap: 10px; }
    
    /* ----------------- Modals ----------------- */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); padding: 20px; }
    .modal-content { background: var(--card); width: 100%; max-width: 500px; border-radius: 16px; padding: 2rem; position: relative; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow); }
    .modal-content.large { max-width: 1000px; }
    .close-modal { position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; color: var(--muted); cursor: pointer; z-index: 10; }

    /* ----------------- Mobile Responsive ----------------- */
    @media (max-width: 768px) {
        header { padding: 0 1.5rem; }
        #navLinks { 
            position: fixed; top: 70px; left: 0; width: 100%; background: var(--card); 
            flex-direction: column; padding: 1rem; border-bottom: 1px solid var(--border);
            display: none; box-shadow: var(--shadow);
        }
        #navLinks.show { display: flex; }
        #mobileMenuBtn { display: block; }
        
        .detail-container { grid-template-columns: 1fr; }
        .filters { flex-direction: column; gap: 1rem; }
        .filters > div, .filters input, .filters select { width: 100%; }
        
        h1 { font-size: 1.5rem; }
        .stat-card .value { font-size: 2rem; }
    }
    
    .fine { font-size: 0.85rem; color: var(--muted); }
  </style>
</head>
<body>

  <header>
    <div id="logo" onclick="setView('home')">üìö Book Hub</div>
    
    <div id="mobileMenuBtn">‚ò∞</div>

    <nav id="navLinks">
      <div class="nav-link active" onclick="setView('home')">Home</div>
      <div class="nav-link" onclick="setView('listings')">Browse Books</div>
      <div class="nav-link" onclick="setView('add-listing')">Post Book</div>
      <div class="nav-link" onclick="setView('my-listings')">My Listings</div>
      <div id="mobileAuth" style="margin-top: 10px; padding-top:10px; border-top:1px solid var(--border)">
         </div>
    </nav>

    <div id="authControls">
        <button id="themeToggle" title="Toggle Theme">üåô</button>
        <button id="authBtn" class="btn brand" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Sign In</button>
    </div>
  </header>

  <main>
    <section id="homeView">
        <div style="text-align: center; margin-bottom: 3rem;">
            <h1>Welcome to Book Hub</h1>
            <p class="fine">The easiest way to buy, sell, and exchange books with your local community.</p>
        </div>

        <div class="dashboard-grid" style="margin-bottom: 3rem;">
            <div class="stat-card">
                <h3>Total Listings</h3>
                <div class="value" id="statTotalBooks">0</div>
            </div>
            <div class="stat-card">
                <h3>Your Listings</h3>
                <div class="value" id="statMyListings">0</div>
            </div>
            <div class="stat-card">
                <h3>Active Users</h3>
                <div class="value">120+</div>
            </div>
        </div>

        <div style="background: var(--card); padding: 2rem; border-radius: 12px; border: 1px solid var(--border); text-align: center;">
            <h2>How it works</h2>
            <div class="dashboard-grid">
                <div>
                    <div style="font-size: 2rem; margin-bottom: 10px;">üìù</div>
                    <h3>1. Post a Book</h3>
                    <p class="fine">Upload details, price, and contact info.</p>
                </div>
                <div>
                    <div style="font-size: 2rem; margin-bottom: 10px;">üîç</div>
                    <h3>2. Discover</h3>
                    <p class="fine">Browse listings from other readers.</p>
                </div>
                <div>
                    <div style="font-size: 2rem; margin-bottom: 10px;">üí¨</div>
                    <h3>3. Chat & Deal</h3>
                    <p class="fine">Message sellers securely to arrange exchange.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="listingsView" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h1>All Listings</h1>
        </div>

        <div class="filters">
            <input type="text" id="q" placeholder="Search title, author..." style="flex: 2;">
            <select id="typeFilter" style="flex: 1;">
                <option value="">All Types</option>
                <option value="Sale">For Sale</option>
                <option value="Exchange">Exchange</option>
            </select>
            <select id="sortBy" style="flex: 1;">
                <option value="new">Newest</option>
                <option value="priceAsc">Price: Low to High</option>
                <option value="priceDesc">Price: High to Low</option>
            </select>
        </div>

        <div id="listingsGrid" class="dashboard-grid"></div>
        <div id="emptyListings" class="hidden" style="text-align: center; padding: 3rem; color: var(--muted);">No books found matching your criteria.</div>
    </section>

    <section id="my-listingsView" class="hidden">
        <h1>My Listings</h1>
        <p class="fine">Manage books you are selling or exchanging.</p>
        <div id="myListingsGrid" class="dashboard-grid"></div>
        <div id="emptyMyListings" class="hidden" style="text-align: center; padding: 3rem; color: var(--muted);">
            <h3>You haven't posted any books yet.</h3>
            <button class="btn brand" onclick="setView('add-listing')" style="margin-top: 1rem;">Post a Book</button>
        </div>
    </section>

    <section id="add-listingView" class="hidden">
        <div style="max-width: 600px; margin: 0 auto;">
            <h1 style="text-align: center;">Post a New Book</h1>
            <p class="fine" style="text-align: center; margin-bottom: 2rem;">Share your book with the community.</p>

            <form id="listingForm" style="background: var(--card); padding: 2rem; border-radius: 12px; border: 1px solid var(--border);">
                <div class="form-group">
                    <label>Book Title *</label>
                    <input type="text" name="title" required placeholder="e.g. The Great Gatsby">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Author *</label>
                        <input type="text" name="author" required>
                    </div>
                    <div class="form-group">
                        <label>Condition</label>
                        <select name="condition">
                            <option value="New">New</option>
                            <option value="Like New">Like New</option>
                            <option value="Good" selected>Good</option>
                            <option value="Acceptable">Acceptable</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Description *</label>
                    <textarea name="description" required placeholder="Brief summary, condition notes..." rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label>Contact Info * (Visible to users)</label>
                    <input type="text" name="contact" required placeholder="Phone number or Email">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Listing Type</label>
                        <select name="type" id="typeSelect">
                            <option value="Sale">For Sale</option>
                            <option value="Exchange">Exchange</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Price (‚Çπ)</label>
                        <input type="number" name="price" id="priceInput" value="0" min="0" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Cover Image</label>
                    <input type="file" id="imageInput" accept="image/*">
                    <img id="preview" src="" style="display:none; width: 100%; height: 150px; object-fit: cover; margin-top: 10px; border-radius: 8px;">
                </div>

                <button type="submit" class="btn brand btn-full">Publish Listing</button>
            </form>
        </div>
    </section>
  </main>

  <div id="authModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('authModal')">&times;</span>
        <div style="text-align: center; margin-bottom: 20px;">
            <h2 id="authTitle">Welcome Back</h2>
            <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
                <button class="btn ghost" id="tabLogin" onclick="switchAuthTab('login')">Login</button>
                <button class="btn ghost" id="tabSignup" onclick="switchAuthTab('signup')">Sign Up</button>
            </div>
        </div>
        
        <form id="authForm">
            <input type="hidden" id="authMode" value="login">
            <div class="form-group" id="nameGroup" style="display:none;">
                <label>Full Name</label>
                <input type="text" id="authName">
            </div>
            <div class="form-group">
                <label>Email (must be @gmail.com)</label>
                <input type="email" id="authEmail" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="authPassword" required>
            </div>
            <button type="submit" class="btn brand btn-full">Continue</button>
        </form>
    </div>
  </div>

  <div id="detailModal" class="modal">
    <div class="modal-content large">
        <span class="close-modal" onclick="closeModal('detailModal')">&times;</span>
        <div id="detailContent"></div>
    </div>
  </div>

  <script>
    /* --- CONFIGURATION --- */
    const API_BASE = '/api'; 
    const qs = s => document.querySelector(s);
    
    // --- STATE MANAGEMENT ---
    const store = {
        get user() { return JSON.parse(localStorage.getItem('user') || 'null'); },
        set user(v) { localStorage.setItem('user', JSON.stringify(v)); },
        listings: [],
        activeListing: null
    };

    // --- UI HELPERS ---
    const escapeHtml = (unsafe) => (unsafe || "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[m]));
    const openModal = (id) => qs('#'+id).style.display = 'flex';
    const closeModal = (id) => qs('#'+id).style.display = 'none';
    const toggleMobileMenu = () => qs('#navLinks').classList.toggle('show');

    // --- API WRAPPER ---
    async function apiFetch(endpoint, options = {}) {
        const headers = { 'Content-Type': 'application/json' };
        if (store.user?.token) headers['Authorization'] = `Bearer ${store.user.token}`;
        
        try {
            const res = await fetch(API_BASE + endpoint, { ...options, headers });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message || 'API Error');
            return data;
        } catch (err) {
            alert(err.message);
            if (err.message.includes('token') || err.message.includes('Unauthorized')) logout();
            return null;
        }
    }

    // --- VIEWS ---
    function setView(view) {
        if (['add-listing', 'my-listings'].includes(view) && !store.user) {
            alert("Please sign in first.");
            openModal('authModal');
            return;
        }
        document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
        qs(`#${view}View`).classList.remove('hidden');
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        
        // Find link and make active
        const activeLink = Array.from(document.querySelectorAll('.nav-link')).find(el => el.textContent.toLowerCase().includes(view.replace('-', ' ')));
        if(activeLink) activeLink.classList.add('active');

        qs('#navLinks').classList.remove('show'); // Close mobile menu

        if (view === 'listings') renderListings();
        if (view === 'my-listings') renderMyListings();
    }

    // --- RENDER LISTINGS ---
    function createCard(book, isMine) {
        const div = document.createElement('div');
        div.className = 'listing-card';
        div.onclick = (e) => { 
             // If remove button clicked, don't open modal
            if(e.target.tagName === 'BUTTON') return; 
            showDetails(book); 
        };

        const priceTag = book.type === 'Exchange' 
            ? '<span class="type-exchange">Exchange</span>' 
            : `<span class="price">‚Çπ${book.price}</span>`;

        div.innerHTML = `
            <img src="${book.image || 'https://via.placeholder.com/400x300?text=No+Cover'}" alt="Cover">
            <div class="info">
                <div class="row">
                    <span class="tag">${book.condition}</span>
                    ${priceTag}
                </div>
                <h3>${escapeHtml(book.title)}</h3>
                <p class="fine">${escapeHtml(book.author)}</p>
                ${isMine ? `<button class="btn danger" onclick="deleteListing('${book._id}')" style="margin-top:auto; padding:0.5rem;">Delete Listing</button>` : ''}
            </div>
        `;
        return div;
    }

    function renderListings() {
        const grid = qs('#listingsGrid');
        grid.innerHTML = '';
        const q = qs('#q').value.toLowerCase();
        const type = qs('#typeFilter').value;
        const sort = qs('#sortBy').value;

        let filtered = store.listings.filter(b => {
            const textMatch = b.title.toLowerCase().includes(q) || b.author.toLowerCase().includes(q);
            const typeMatch = !type || b.type === type;
            return textMatch && typeMatch;
        });

        if (sort === 'priceAsc') filtered.sort((a,b) => a.price - b.price);
        if (sort === 'priceDesc') filtered.sort((a,b) => b.price - a.price);
        if (sort === 'new') filtered.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

        if (filtered.length === 0) qs('#emptyListings').classList.remove('hidden');
        else qs('#emptyListings').classList.add('hidden');

        filtered.forEach(b => grid.appendChild(createCard(b, false)));
    }

    function renderMyListings() {
        const grid = qs('#myListingsGrid');
        grid.innerHTML = '';
        const myBooks = store.listings.filter(b => b.owner.userId === store.user?.userId);
        
        qs('#statMyListings').textContent = myBooks.length;
        
        if (myBooks.length === 0) qs('#emptyMyListings').classList.remove('hidden');
        else qs('#emptyMyListings').classList.add('hidden');

        myBooks.forEach(b => grid.appendChild(createCard(b, true)));
    }

    // --- DETAIL & CHAT ---
    function showDetails(book) {
        store.activeListing = book;
        const isOwner = store.user && store.user.userId === book.owner.userId;
        const msgs = book.msgs || [];

        const html = `
            <div class="detail-container">
                <div class="detail-img-box">
                    <img src="${book.image || 'https://via.placeholder.com/400x300?text=No+Cover'}">
                </div>
                <div class="detail-info">
                    <div>
                        <h1>${escapeHtml(book.title)}</h1>
                        <p class="fine">${escapeHtml(book.author)} ‚Ä¢ ${book.condition}</p>
                    </div>
                    
                    <div class="row">
                         <span class="tag" style="font-size:1rem; background:var(--brand); color:#fff">${book.type}</span>
                         <span class="price" style="font-size:1.5rem"> ${book.type === 'Exchange' ? 'Exchange' : '‚Çπ'+book.price}</span>
                    </div>

                    <div class="contact-box">
                        <strong>üìû Seller Contact:</strong> ${escapeHtml(book.contact)}<br>
                        <small>Posted by: ${escapeHtml(book.owner.name)}</small>
                    </div>

                    <p>${escapeHtml(book.description)}</p>

                    <div class="chat-box">
                        <div class="chat-messages" id="chatMsgs">
                            ${renderChatBubbles(msgs)}
                        </div>
                        ${store.user ? `
                        <form class="chat-input-area" onsubmit="sendMessage(event)">
                            <input type="text" id="chatInput" placeholder="Type a message..." required autocomplete="off">
                            <button type="submit" class="btn brand">Send</button>
                        </form>
                        ` : `<div style="padding:10px; text-align:center; background:var(--card)" class="fine">Sign in to chat</div>`}
                    </div>
                </div>
            </div>
        `;
        qs('#detailContent').innerHTML = html;
        openModal('detailModal');
        scrollToBottom();
    }

    function renderChatBubbles(msgs) {
        if (msgs.length === 0) return '<div class="fine" style="text-align:center; margin-top:20px;">No messages yet. Start the conversation!</div>';
        
        return msgs.map(m => {
            const isMe = store.user && m.by === store.user.name;
            return `
                <div class="msg-bubble ${isMe ? 'sent' : 'received'}">
                    ${escapeHtml(m.text)}
                    <span class="msg-meta">${isMe ? 'Me' : escapeHtml(m.by)} ‚Ä¢ ${new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                </div>
            `;
        }).join('');
    }

    function scrollToBottom() {
        const el = qs('#chatMsgs');
        if(el) el.scrollTop = el.scrollHeight;
    }

    async function sendMessage(e) {
        e.preventDefault();
        const input = qs('#chatInput');
        const text = input.value.trim();
        if (!text) return;

        const res = await apiFetch(`/books/${store.activeListing._id}/message`, {
            method: 'POST', body: JSON.stringify({ text })
        });

        if (res) {
            // Update local state
            store.activeListing.msgs.push(res);
            const masterIdx = store.listings.findIndex(b => b._id === store.activeListing._id);
            if(masterIdx > -1) store.listings[masterIdx].msgs.push(res);
            
            // Re-render chat
            qs('#chatMsgs').innerHTML = renderChatBubbles(store.activeListing.msgs);
            input.value = '';
            scrollToBottom();
        }
    }

    // --- ACTIONS ---
    async function loadBooks() {
        const data = await apiFetch('/books');
        if (data) {
            store.listings = data;
            qs('#statTotalBooks').textContent = data.length;
            renderListings();
        }
    }

    async function deleteListing(id) {
        if(!confirm("Delete this listing?")) return;
        const res = await apiFetch(`/books/${id}`, { method: 'DELETE' });
        if(res && res.success) {
            store.listings = store.listings.filter(b => b._id !== id);
            renderListings();
            renderMyListings();
            closeModal('detailModal');
        }
    }

    // --- FORMS ---
    qs('#listingForm').onsubmit = async (e) => {
        e.preventDefault();
        const f = e.target;
        const img = qs('#preview').src;
        // Check if src is empty or placeholder (simple check)
        const finalImg = img.length > 100 ? img : ''; 

        const payload = {
            title: f.title.value,
            author: f.author.value,
            condition: f.condition.value,
            description: f.description.value,
            contact: f.contact.value,
            type: f.type.value,
            price: f.price.value,
            image: finalImg
        };

        const res = await apiFetch('/books', { method: 'POST', body: JSON.stringify(payload) });
        if(res && res.success) {
            f.reset();
            qs('#preview').style.display='none';
            store.listings.unshift(res.data);
            setView('listings');
        }
    };

    qs('#imageInput').onchange = (e) => {
        const file = e.target.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                qs('#preview').src = ev.target.result;
                qs('#preview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    };

    // --- AUTH ---
    function switchAuthTab(tab) {
        const isLogin = tab === 'login';
        qs('#authMode').value = tab;
        qs('#nameGroup').style.display = isLogin ? 'none' : 'block';
        qs('#tabLogin').className = `btn ${isLogin ? 'brand' : 'ghost'}`;
        qs('#tabSignup').className = `btn ${!isLogin ? 'brand' : 'ghost'}`;
        qs('#authTitle').textContent = isLogin ? 'Welcome Back' : 'Create Account';
    }

    qs('#authForm').onsubmit = async (e) => {
        e.preventDefault();
        const mode = qs('#authMode').value;
        const endpoint = mode === 'login' ? '/auth/login' : '/auth/signup';
        const body = {
            email: qs('#authEmail').value,
            password: qs('#authPassword').value
        };
        if(mode === 'signup') body.name = qs('#authName').value;

        const res = await apiFetch(endpoint, { method: 'POST', body: JSON.stringify(body) });
        if(res && res.success) {
            store.user = res.data;
            updateAuthUI();
            closeModal('authModal');
            loadBooks(); // reload to get my-listings specific data if needed
        }
    };

    function updateAuthUI() {
        const btn = qs('#authBtn');
        if (store.user) {
            btn.textContent = 'Sign Out';
            btn.className = 'btn ghost';
            btn.onclick = logout;
        } else {
            btn.textContent = 'Sign In';
            btn.className = 'btn brand';
            btn.onclick = () => openModal('authModal');
        }
    }

    function logout() {
        store.user = null;
        setView('home');
        updateAuthUI();
    }

    // --- INITIALIZATION ---
    qs('#mobileMenuBtn').addEventListener('click', toggleMobileMenu);
    qs('#themeToggle').onclick = () => {
        document.body.classList.toggle('light-theme');
        qs('#themeToggle').textContent = document.body.classList.contains('light-theme') ? '‚òÄÔ∏è' : 'üåô';
    };

    // Filter listeners
    ['#q', '#typeFilter', '#sortBy'].forEach(s => qs(s).addEventListener('input', renderListings));

    // Start
    loadBooks();
    updateAuthUI();
  </script>
</body>
</html>
